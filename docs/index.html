<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Dual Hub — Nebula Pro (Espelho • Launcher • Brain • Trinity)</title>
<meta name="theme-color" content="#0b0b13">
<style>
/* ========= Nebula Pro (42° #f0f → #0ff) ========= */
:root{
  --nebula-a:#ff00ff; --nebula-b:#00ffff; --angle:42deg;
  --bg-0:#0b0b13; --bg-1:#0f0f19; --bg-2:#151525; --card:#0f1220;
  --txt:#e9eef7; --muted:#a7b1c6; --accent:#9d7dff; --ok:#39FFB6; --warn:#ffd166; --err:#ff5c7a;
  --border:rgba(255,255,255,.08); --shadow:rgba(0,0,0,.5);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--txt); background:
  radial-gradient(1200px 600px at 70% -10%, rgba(157,125,255,.25), transparent 60%),
  linear-gradient(var(--angle), var(--nebula-a), var(--nebula-b));
  background-attachment: fixed;
  min-height:100%;
  font: 14px/1.45 "Inter", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
}
a{color:var(--ok); text-decoration:none}
button{cursor:pointer}
.hidden{display:none!important}
.row{display:flex; gap:.75rem}
.col{display:flex; flex-direction:column; gap:.75rem}

/* ======= Shell ======= */
.app{
  display:flex; flex-direction:column; min-height:100dvh;
  backdrop-filter: blur(6px);
}
.header{
  position:sticky; top:0; z-index:10;
  display:flex; align-items:center; gap:.5rem;
  padding:.6rem .8rem; background:color-mix(in oklab, var(--bg-0) 80%, transparent);
  border-bottom:1px solid var(--border);
  box-shadow: 0 6px 18px -12px var(--shadow);
}
.brand{
  display:flex; align-items:center; gap:.6rem; font-weight:700; letter-spacing:.2px;
}
.brand .logo{
  width:28px; height:28px; border-radius:50%;
  background: conic-gradient(from 0turn, var(--nebula-a), var(--nebula-b), var(--nebula-a));
  position:relative; box-shadow:0 0 0 2px rgba(255,255,255,.08) inset, 0 0 18px rgba(0,0,0,.25);
}
.brand .logo:after{
  content:""; position:absolute; inset:4px; border-radius:50%;
  background: radial-gradient(circle at 50% 40%, rgba(255,255,255,.35), rgba(255,255,255,0) 55%);
  animation: breathe 3.6s ease-in-out infinite;
}
@keyframes breathe{0%,100%{transform:scale(1)}50%{transform:scale(1.04)}}
.nav{
  margin-left:auto; display:flex; gap:.35rem; overflow:auto hidden; padding-bottom:.25rem;
}
.btn{
  display:inline-flex; align-items:center; gap:.5rem;
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid var(--border); color:var(--txt);
  padding:.5rem .7rem; border-radius:14px; white-space:nowrap;
}
.btn.ghost{background:transparent}
.btn.primary{
  border-color: color-mix(in oklab, var(--ok) 30%, var(--border));
  box-shadow: 0 8px 20px -12px rgba(57,255,182,.7);
}
.dot{
  width:10px; height:10px; border-radius:50%;
  background: var(--ok);
  box-shadow:0 0 0 0 rgba(57,255,182,.5);
  animation: dotPulse 2.4s ease-out infinite;
}
@keyframes dotPulse{0%{box-shadow:0 0 0 0 rgba(57,255,182,.6)}70%{box-shadow:0 0 0 10px rgba(57,255,182,0)}100%{box-shadow:0 0 0 0 rgba(57,255,182,0)}}

.main{flex:1; display:grid; grid-template-rows:auto 1fr;}

/* Tabs */
.tabs{display:flex; gap:.4rem; padding:.6rem .8rem; border-bottom:1px solid var(--border); background:color-mix(in oklab, var(--bg-0) 70%, transparent)}
.tab{padding:.45rem .7rem; border:1px solid transparent; border-radius:12px; color:var(--muted)}
.tab.active{border-color:var(--border); color:var(--txt); background:rgba(255,255,255,.04)}

/* Surfaces */
.surface{
  padding:clamp(.8rem, 1.6vw, 1.2rem);
  display:grid; gap:1rem;
}

/* ====== Espelho Dual (Home) ====== */
.portal{
  display:grid; place-items:center; min-height:58dvh;
}
.portal-card{
  width:min(980px, 92vw);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid var(--border); border-radius:20px; padding:1.1rem;
  box-shadow: 0 30px 80px -40px var(--shadow);
}
.portal-hero{
  display:grid; grid-template-columns:1.1fr .9fr; gap:1rem; align-items:center;
}
@media (max-width:900px){ .portal-hero{grid-template-columns:1fr;}}
.canvas{
  aspect-ratio:1/1; border-radius:24px; background:radial-gradient(circle at 50% 60%, rgba(255,255,255,.08), transparent 65%);
  display:grid; place-items:center; position:relative; isolation:isolate; overflow:hidden; border:1px solid var(--border);
}
.mirror{
  width:74%; aspect-ratio:1/1; border-radius:50%;
  background:
   radial-gradient(120px 60px at 50% 30%, rgba(255,255,255,.28), transparent 60%),
   conic-gradient(from 0turn, rgba(255,255,255,.08), rgba(255,255,255,.0) 30%, rgba(255,255,255,.08) 60%, rgba(255,255,255,.0) 100%),
   linear-gradient(var(--angle), color-mix(in oklab, var(--nebula-a) 70%, white 8%), color-mix(in oklab, var(--nebula-b) 70%, white 8%));
  box-shadow:
   0 0 0 2px rgba(255,255,255,.08) inset,
   0 40px 120px -40px rgba(0,0,0,.5),
   0 0 120px 20px color-mix(in oklab, var(--nebula-b) 20%, transparent);
  position:relative;
  animation: spin 24s linear infinite;
}
.mirror:after{
  content:""; position:absolute; inset:0; border-radius:50%;
  background: radial-gradient(300px 140px at 50% 10%, rgba(255,255,255,.15), transparent 50%);
  mix-blend-mode:screen;
}
@keyframes spin{to{transform:rotate(360deg)}}
.pulse{
  position:absolute; inset:-20%; border-radius:50%;
  background: radial-gradient(circle at 50% 50%, rgba(157,125,255,.15), rgba(157,125,255,0) 55%);
  filter: blur(20px); animation: halo 5.2s ease-in-out infinite;
}
@keyframes halo{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}

.kicker{opacity:.75; font-size:.86rem}
.title{font-size: clamp(1.2rem, 2.4vw, 1.8rem); font-weight:800; letter-spacing:.2px}
.lead{color:var(--muted); margin:.4rem 0 1rem}
.actions{display:flex; flex-wrap:wrap; gap:.5rem}
.badge{font-size:.75rem; padding:.25rem .5rem; border:1px solid var(--border); border-radius:999px; background:rgba(255,255,255,.04)}

/* ===== Launcher ===== */
.grid{
  display:grid; gap:.75rem;
  grid-template-columns: repeat( auto-fill, minmax(160px, 1fr) );
}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid var(--border); border-radius:16px; padding:.75rem; display:flex; flex-direction:column; gap:.5rem;
}
.app-icon{
  width:48px; height:48px; border-radius:12px; background:rgba(255,255,255,.06);
  display:grid; place-items:center; border:1px solid var(--border);
}
.app-icon svg{width:26px; height:26px; opacity:.9}
.meta{font-size:.8rem; color:var(--muted)}
.row-btns{display:flex; gap:.4rem; margin-top:auto}
.btn.sm{padding:.38rem .6rem; border-radius:10px; font-size:.82rem}

/* ===== Brain ===== */
.field{display:grid; gap:.35rem}
.input, .textarea, .select{
  width:100%; color:var(--txt); background:rgba(255,255,255,.04);
  border:1px solid var(--border); border-radius:12px; padding:.55rem .7rem;
}
.textarea{min-height:120px; resize:vertical}
.kv{display:grid; grid-template-columns:1fr auto; align-items:center; gap:.5rem}
.loader-dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 0 rgba(157,125,255,.6);animation:dotPulse 2.6s ease-out infinite}

/* ===== Viewer ===== */
.viewer-wrap{position:relative}
.viewer{
  width:100%; height:min(70dvh, 70vh);
  border:1px solid var(--border); border-radius:16px; background:#0a0c16;
}
.viewer-controls{
  position:absolute; right:.6rem; top:.6rem; display:flex; gap:.4rem;
}
.badge-float{
  position:fixed; right:.9rem; bottom:4.2rem; z-index:50;
  display:none; align-items:center; gap:.5rem;
}

/* ===== Trinity ===== */
.tri-grid{display:grid; gap:.75rem; grid-template-columns:1fr 1fr}
@media (max-width:1000px){.tri-grid{grid-template-columns:1fr}}
.tri-box{min-height:240px; border:1px solid var(--border); border-radius:16px; background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); padding:.75rem}
.small{font-size:.85rem; color:var(--muted)}
hr.sep{border:0; height:1px; background:var(--border); margin:.5rem 0}

/* ===== Chips ===== */
.chips{display:flex; gap:.4rem; flex-wrap:wrap}
.chip{padding:.25rem .55rem; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.04); font-size:.78rem}

.footer{
  padding:.7rem; display:flex; justify-content:space-between; align-items:center;
  border-top:1px solid var(--border); background:color-mix(in oklab, var(--bg-0) 80%, transparent)
}
.minibar{display:flex; gap:.5rem; align-items:center}
.minibar .btn{padding:.4rem .6rem}
</style>
</head>
<body>
<div class="app" id="app">
  <!-- Header -->
  <header class="header">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>Dual Hub</div>
      <span class="badge">Nebula Pro</span>
    </div>
    <div class="nav" id="topNav">
      <button class="btn tabBtn" data-tab="home">Espelho</button>
      <button class="btn tabBtn" data-tab="launcher">Launcher</button>
      <button class="btn tabBtn" data-tab="brain">Dual Brain</button>
      <button class="btn tabBtn" data-tab="trinity">Trinity</button>
      <button class="btn tabBtn" data-tab="viewer">Viewer</button>
      <button class="btn ghost" id="statusBtn"><span class="dot" title="Sincronizado"></span></button>
    </div>
  </header>

  <!-- Tabs (breadcrumb-ish) -->
  <div class="tabs">
    <button class="tab active" data-tab="home">Home</button>
    <button class="tab" data-tab="launcher">Launcher</button>
    <button class="tab" data-tab="brain">Brain</button>
    <button class="tab" data-tab="trinity">Trinity</button>
    <button class="tab" data-tab="viewer">Viewer</button>
  </div>

  <!-- Content Surfaces -->
  <main class="main">
    <!-- HOME / ESPELHO -->
    <section class="surface" data-panel="home">
      <div class="portal">
        <div class="portal-card">
          <div class="portal-hero">
            <div class="canvas">
              <div class="pulse"></div>
              <div class="mirror" aria-hidden="true"></div>
            </div>
            <div class="col">
              <div class="kicker">✨ Espelho Dual</div>
              <div class="title">Portal Místico · Intenção → Toques → Ativações</div>
              <p class="lead">Abra o Hub e já reflita o pulso: registre intenções, toque o centro, acione arquétipos. O espelho conversa com seu Brain e com o Launcher.</p>
              <div class="actions">
                <button class="btn primary" data-goto="launcher">Abrir Launcher</button>
                <button class="btn" data-goto="brain">Ir ao Dual Brain</button>
                <span class="badge">⚡️ Tríade ativa: <span id="triade">⚡️ ⭕️ ⚡️</span></span>
              </div>
              <div class="chips" id="intentsChips"></div>
              <small class="small">Dica: toque o status (ponto verde) para ver perfis/sincronização.</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Intention -->
      <div class="card">
        <div class="row" style="align-items:center; justify-content:space-between;">
          <div class="row" style="align-items:center;">
            <strong>Registrar intenção</strong>
            <span class="badge">localStorage</span>
          </div>
          <div class="row">
            <button class="btn sm" id="btnIntentSample">Gerar exemplo</button>
          </div>
        </div>
        <div class="row">
          <input class="input" id="intentInput" placeholder="Escreva uma intenção…"/>
          <button class="btn sm primary" id="intentAdd">Salvar</button>
        </div>
      </div>
    </section>

    <!-- LAUNCHER -->
    <section class="surface hidden" data-panel="launcher">
      <div class="row" style="flex-wrap:wrap; align-items:center; justify-content:space-between">
        <div class="row" style="align-items:center">
          <strong>Launcher</strong>
          <span class="badge">Apps por grupos • Favoritos • Recentes</span>
        </div>
        <div class="row">
          <label class="btn sm">
            Importar apps.json
            <input type="file" id="appsImport" accept=".json" hidden>
          </label>
          <label class="btn sm">
            Upload HTML
            <input type="file" id="htmlUpload" accept=".html,.htm" hidden>
          </label>
          <button class="btn sm" id="appsReset">Reset defaults</button>
        </div>
      </div>

      <div class="row" style="flex-wrap:wrap; gap:.5rem">
        <select class="select" id="groupFilter" style="max-width:220px">
          <option value="">Todos os grupos</option>
        </select>
        <input class="input" id="searchApps" placeholder="Buscar apps… (nome, tags)"/>
      </div>

      <div id="appsGrid" class="grid"></div>

      <h4>Favoritos</h4>
      <div id="favGrid" class="grid"></div>

      <h4>Recentes</h4>
      <div id="recentGrid" class="grid"></div>
    </section>

    <!-- BRAIN -->
    <section class="surface hidden" data-panel="brain">
      <div class="grid" style="grid-template-columns:1.1fr .9fr">
        <!-- Perfil -->
        <div class="card">
          <strong>Perfil</strong>
          <div class="field">
            <label>Nome</label>
            <input class="input" id="profileName" placeholder="Seu nome…">
          </div>
          <div class="field">
            <label>SK (OpenRouter)</label>
            <input class="input" id="profileSK" placeholder="sk-or-v1-…">
          </div>
          <div class="row" style="align-items:center; justify-content:space-between">
            <div class="row" style="align-items:center; gap:.5rem">
              <span class="loader-dot" title="autosave"></span>
              <small class="small">AutoSave</small>
            </div>
            <div class="row">
              <button class="btn sm" id="brainExport">Exportar Brain</button>
              <label class="btn sm">Importar Brain<input type="file" id="brainImport" accept=".json" hidden></label>
              <button class="btn sm" id="brainReset">Reset</button>
            </div>
          </div>
          <hr class="sep"/>
          <div class="field">
            <label>Treinamento (JSON/Texto)</label>
            <textarea class="textarea" id="training"></textarea>
          </div>
        </div>

        <!-- Arquétipos -->
        <div class="card">
          <strong>Ativações — 12 Arquétipos</strong>
          <div class="chips" id="archetypesChips"></div>
          <hr class="sep"/>
          <div class="row" style="align-items:center; justify-content:space-between">
            <div class="row" style="align-items:center">
              <span class="badge">Ritual cues</span>
              <small class="small">Cliques discretos entre blocos</small>
            </div>
            <div class="row">
              <button class="btn sm" id="playCue">Tocar cue</button>
              <button class="btn sm" id="triadeGen">Gerar Tríade</button>
            </div>
          </div>
          <div class="row">
            <input class="input" id="triadeOut" readonly value="⚡️ ⭕️ ⚡️"/>
          </div>
        </div>
      </div>
    </section>

    <!-- TRINITY -->
    <section class="surface hidden" data-panel="trinity">
      <div class="tri-grid">
        <div class="tri-box">
          <strong>Host (Hub)</strong>
          <p class="small">O Host sincroniza tema/ações via <code>postMessage</code> com os viewers.</p>
          <div class="row">
            <button class="btn sm" id="triSyncTheme">Sync Tema</button>
            <button class="btn sm" id="triSendPing">Ping</button>
          </div>
          <hr class="sep"/>
          <div class="row">
            <textarea class="textarea" id="triLog" placeholder="Logs do Trinity…" style="min-height:120px"></textarea>
          </div>
        </div>
        <div class="col">
          <div class="tri-box">
            <strong>Viewer A</strong>
            <iframe id="triA" class="viewer" title="Trinity A"></iframe>
            <div class="small">Carrega apps/HTMLs locais; recebe pings/tema.</div>
          </div>
          <div class="tri-box">
            <strong>Viewer B</strong>
            <iframe id="triB" class="viewer" title="Trinity B"></iframe>
            <div class="small">Segundo canal para experimentos/Chat.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- VIEWER -->
    <section class="surface hidden" data-panel="viewer">
      <div class="viewer-wrap">
        <iframe id="appViewer" class="viewer" title="App Viewer" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
        <div class="viewer-controls">
          <button class="btn sm" id="viewerBack">⬅ Hub</button>
          <button class="btn sm" id="viewerMin">— Minimizar</button>
          <button class="btn sm" id="viewerReload">⟳ Recarregar</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer / Minibar -->
  <footer class="footer">
    <div class="minibar">
      <span class="badge">Toque o pulso com intenção</span>
      <span id="miniIntent" class="small"></span>
    </div>
    <div class="row">
      <button class="btn" data-goto="home">Espelho</button>
      <button class="btn" data-goto="launcher">Launcher</button>
      <button class="btn" data-goto="brain">Brain</button>
      <button class="btn" data-goto="trinity">Trinity</button>
      <button class="btn" data-goto="viewer">Viewer</button>
    </div>
  </footer>

  <div id="reopenBadge" class="badge-float">
    <span class="badge">◐ Reabrir App</span>
    <button class="btn sm" id="viewerOpen">Abrir</button>
  </div>
</div>

<script>
/* =========== State / Storage Helpers =========== */
const S = {
  get(k, fallback){ try{ return JSON.parse(localStorage.getItem(k)) ?? fallback }catch(e){ return fallback }},
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)) }
};
const qs = (sel, el=document)=>el.querySelector(sel);
const qsa = (sel, el=document)=>[...el.querySelectorAll(sel)];
const panels = {};

/* =========== Tabs / Routing (hashless simple) =========== */
function showTab(key){
  qsa('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===key));
  qsa('[data-panel]').forEach(p=>p.classList.toggle('hidden', p.dataset.panel!==key));
  // If viewer tab -> ensure badge hidden
  if(key==='viewer'){ badge(false) }
}
qsa('.tab').forEach(b=>b.addEventListener('click', ()=>showTab(b.dataset.tab)));
qsa('[data-goto]').forEach(b=>b.addEventListener('click', ()=>showTab(b.dataset.goto)));
qsa('.tabBtn').forEach(b=>b.addEventListener('click', ()=>showTab(b.dataset.tab)));
showTab('home');

/* =========== Espelho: Intenções =========== */
const intentsKey='dual.intents';
function renderIntents(){
  const chips=qs('#intentsChips'); chips.innerHTML='';
  const list=S.get(intentsKey,[]);
  list.slice(-12).reverse().forEach(txt=>{
    const s=document.createElement('span'); s.className='chip'; s.textContent=txt; chips.appendChild(s);
  });
  qs('#miniIntent').textContent=list.at(-1) || '';
}
qs('#intentAdd').addEventListener('click', ()=>{
  const v = qs('#intentInput').value.trim(); if(!v) return;
  const list=S.get(intentsKey,[]); list.push(v); S.set(intentsKey,list); qs('#intentInput').value='';
  renderIntents();
});
qs('#btnIntentSample').addEventListener('click', ()=>{
  const samples=['Respirar no centro','Hoje eu avanço 1%','Somar beleza ao essencial','Fluxo leve e profundo','Ligação com o mestre interior'];
  qs('#intentInput').value = samples[Math.floor(Math.random()*samples.length)];
});
renderIntents();

/* =========== Defaults: Apps + Archetypes =========== */
const archetypeList = ['Atlas','Nova','Kaion','Elysha','Serena','Artemis','Lumine','Genus','Vitalis','Aion','Rhea','Horus'];
const appsDefault = [
  {id:'chat', name:'Dual Chat', grupo:'Core', url:'about:blank', tags:['ai','chat'], icon:'chat'},
  {id:'editor', name:'Editor HTML/CSS/JS', grupo:'Criação', url:'about:blank', tags:['code','editor'], icon:'code'},
  {id:'dual', name:'Dual (Home)', grupo:'Core', url:'about:blank', tags:['hub'], icon:'dual'},
  {id:'twitter', name:'Twitter/YouTube', grupo:'Social', url:'https://twitter.com', tags:['social'], icon:'social'},
  {id:'nlst', name:'Next Level Sound Tracks', grupo:'Áudio', url:'about:blank', tags:['audio','gen'], icon:'sound'},
  {id:'koblox', name:'KOBLOX Player', grupo:'Áudio', url:'about:blank', tags:['player'], icon:'player'},
  {id:'books', name:'Dual Books', grupo:'Conteúdo', url:'about:blank', tags:['text','speech'], icon:'book'},
  {id:'brain', name:'Dual Brain', grupo:'Core', url:'about:blank', tags:['brain'], icon:'brain'}
];

/* =========== Icons (try icons/others/* fallback to inline) =========== */
function iconSVG(name){
  // Fallback minimal SVG set (monoline)
  const map = {
    chat:'<path d="M4 5h16v10H8l-4 4V5z" fill="none" stroke="currentColor" stroke-width="1.6"/>',
    code:'<path d="M9 5l-6 7 6 7M15 5l6 7-6 7" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>',
    dual:'<circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="M12 3v18M3 12h18" stroke="currentColor" stroke-width="1.6"/>',
    social:'<circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="M6 14c2 2 10 2 12-2" stroke="currentColor" stroke-width="1.6"/>',
    sound:'<path d="M4 10h4l5-4v12l-5-4H4zM18 9a3 3 0 010 6M20 7a5 5 0 010 10" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>',
    player:'<circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="M10 9l6 3-6 3z" fill="currentColor"/>',
    book:'<path d="M5 5h8a3 3 0 013 3v11H8a3 3 0 01-3-3V5z" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="M16 8h3v11h-3" fill="none" stroke="currentColor" stroke-width="1.6"/>',
    brain:'<path d="M9 7a3 3 0 00-6 1v6a3 3 0 006 1m6-8a3 3 0 116 1v6a3 3 0 01-6 1" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>'}
  return `<svg viewBox="0 0 24 24" aria-hidden="true">${map[name]||map.dual}</svg>`;
}

/* =========== Launcher Render =========== */
const appsKey='dual.apps', favKey='dual.favorites', recKey='dual.recents';
async function loadApps(){
  let apps = S.get(appsKey, null);
  if(!apps){
    // Try fetch /apps/apps.json (optional)
    try{
      const r = await fetch('apps/apps.json', {cache:'no-store'});
      if(r.ok){ apps = await r.json(); S.set(appsKey, apps); }
    }catch(e){}
  }
  if(!apps){ apps = appsDefault; S.set(appsKey, appsDefault); }
  populateGroups(apps); renderApps(apps); renderFav(); renderRecent();
}
function populateGroups(apps){
  const sel=qs('#groupFilter'); const groups=[...new Set(apps.map(a=>a.grupo).filter(Boolean))].sort();
  sel.innerHTML='<option value="">Todos os grupos</option>'+groups.map(g=>`<option>${g}</option>`).join('');
}
function matchApp(app, term){ 
  if(!term) return true; term=term.toLowerCase();
  return app.name.toLowerCase().includes(term) || (app.tags||[]).some(t=>t.toLowerCase().includes(term));
}
function renderApps(apps){
  const wrap=qs('#appsGrid'); wrap.innerHTML='';
  const group=qs('#groupFilter').value; const term=qs('#searchApps').value;
  const favs=new Set(S.get(favKey,[]));
  apps.filter(a=>!group||a.grupo===group).filter(a=>matchApp(a,term)).forEach(a=>{
    const card=document.createElement('div'); card.className='card';
    const icon=document.createElement('div'); icon.className='app-icon'; icon.innerHTML=iconSVG(a.icon);
    const title=document.createElement('div'); title.innerHTML=`<strong>${a.name}</strong>`;
    const meta=document.createElement('div'); meta.className='meta'; meta.textContent=a.grupo || '—';
    const btns=document.createElement('div'); btns.className='row-btns';
    const btnOpen=btn('Abrir', 'primary sm', ()=>openInViewer(a));
    const btnFav=btn(favs.has(a.id)?'★ Fav':'☆ Fav', 'sm', ()=>toggleFav(a.id));
    const btnIns=btn('Injection', 'sm', ()=>injectToTrinity(a));
    btns.append(btnOpen, btnFav, btnIns);
    card.append(icon, title, meta, btns);
    wrap.append(card);
  });
}
function btn(txt, cls, onclick){ const b=document.createElement('button'); b.className='btn '+cls; b.textContent=txt; b.onclick=onclick; return b; }
function toggleFav(id){ const fav=new Set(S.get(favKey,[])); fav.has(id)?fav.delete(id):fav.add(id); S.set(favKey,[...fav]); renderApps(S.get(appsKey,appsDefault)); renderFav(); }
function openInViewer(app){
  const vf=qs('#appViewer');
  try{ vf.src = app.url || 'about:blank'; }catch(e){ vf.removeAttribute('src'); }
  showTab('viewer'); addRecent(app.id);
}
function addRecent(id){
  const arr=S.get(recKey,[]); const without=arr.filter(x=>x!==id); without.push(id); S.set(recKey, without.slice(-12)); renderRecent();
}
function renderFav(){
  const wrap=qs('#favGrid'); wrap.innerHTML='';
  const apps=S.get(appsKey,appsDefault); const fav=new Set(S.get(favKey,[]));
  apps.filter(a=>fav.has(a.id)).forEach(a=>{
    const c=document.createElement('div'); c.className='card';
    c.innerHTML=`<div class="app-icon">${iconSVG(a.icon)}</div><strong>${a.name}</strong><div class="meta">${a.grupo||'—'}</div>`;
    const open=btn('Abrir','primary sm', ()=>openInViewer(a));
    c.append(open); wrap.append(c);
  });
}
function renderRecent(){
  const wrap=qs('#recentGrid'); wrap.innerHTML='';
  const apps=S.get(appsKey,appsDefault); const ids=S.get(recKey,[]);
  ids.slice().reverse().forEach(id=>{
    const a=apps.find(x=>x.id===id); if(!a) return;
    const c=document.createElement('div'); c.className='card';
    c.innerHTML=`<div class="app-icon">${iconSVG(a.icon)}</div><strong>${a.name}</strong><div class="meta">${a.grupo||'—'}</div>`;
    const open=btn('Abrir','primary sm', ()=>openInViewer(a));
    c.append(open); wrap.append(c);
  });
}
qs('#groupFilter').addEventListener('change', ()=>renderApps(S.get(appsKey,appsDefault)));
qs('#searchApps').addEventListener('input', ()=>renderApps(S.get(appsKey,appsDefault)));
qs('#appsReset').addEventListener('click', ()=>{ S.set(appsKey,appsDefault); S.set(favKey,[]); S.set(recKey,[]); loadApps(); });

qs('#appsImport').addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{ const apps = JSON.parse(await f.text()); S.set(appsKey,apps); loadApps(); }catch(err){ alert('JSON inválido'); }
});
qs('#htmlUpload').addEventListener('change', (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  const temp = {id:'upload-'+Date.now(), name:f.name, grupo:'Uploads', url, tags:['upload'], icon:'dual'};
  const apps = S.get(appsKey,appsDefault); apps.push(temp); S.set(appsKey,apps); loadApps(); openInViewer(temp);
});

/* =========== Brain (profile, training) =========== */
const profKey='dual.brain.profile', trainKey='dual.brain.training', archKey='dual.archetypes';
function autosaveProfile(){
  const profile = {
    name: qs('#profileName').value.trim(),
    sk: qs('#profileSK').value.trim()
  };
  S.set(profKey, profile);
}
['#profileName','#profileSK'].forEach(sel=>qs(sel).addEventListener('input', ()=>{ autosaveProfile(); pingStatus(); }));
qs('#training').addEventListener('input', ()=>S.set(trainKey, qs('#training').value));
function loadBrain(){
  const p=S.get(profKey,{name:'',sk:''}); qs('#profileName').value=p.name||''; qs('#profileSK').value=p.sk||'';
  qs('#training').value = S.get(trainKey,'');
}
qs('#brainExport').addEventListener('click', ()=>{
  const data = {
    profile:S.get(profKey,{}), training:S.get(trainKey,''), apps:S.get(appsKey,appsDefault),
    favorites:S.get(favKey,[]), recents:S.get(recKey,[]), archetypes:S.get(archKey, {})
  };
  const blob=new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dual_brain_export.json'; a.click();
});
qs('#brainImport').addEventListener('change', async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{
    const data=JSON.parse(await f.text());
    if(data.profile) S.set(profKey, data.profile);
    if('training' in data) S.set(trainKey, data.training);
    if(Array.isArray(data.apps)) S.set(appsKey, data.apps);
    if(Array.isArray(data.favorites)) S.set(favKey, data.favorites);
    if(Array.isArray(data.recents)) S.set(recKey, data.recents);
    if(data.archetypes) S.set(archKey, data.archetypes);
    loadBrain(); loadApps(); alert('Brain importado!');
  }catch(err){ alert('Arquivo inválido'); }
});
qs('#brainReset').addEventListener('click', ()=>{
  [profKey,trainKey,appsKey,favKey,recKey,archKey].forEach(k=>localStorage.removeItem(k));
  loadBrain(); loadApps(); renderArchetypes(); renderIntents();
});

/* =========== Archetypes Chips + Cue + Tríade =========== */
function renderArchetypes(){
  const wrap=qs('#archetypesChips'); wrap.innerHTML='';
  const state=S.get(archKey, {});
  archetypeList.forEach(name=>{
    const on=!!state[name]; const el=document.createElement('button');
    el.className='chip'; el.textContent=(on?'● ':'○ ')+name;
    el.onclick=()=>{ state[name]=!state[name]; S.set(archKey,state); renderArchetypes(); };
    wrap.append(el);
  });
}
renderArchetypes();

let audioCtx;
qs('#playCue').addEventListener('click', ()=>{
  audioCtx ||= new (window.AudioContext||window.webkitAudioContext)();
  function click(t=0, f=1600){ const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='square'; o.frequency.value=f; o.connect(g); g.connect(audioCtx.destination);
    const now=audioCtx.currentTime + t; g.gain.setValueAtTime(.0001, now); g.gain.exponentialRampToValueAtTime(.3, now+.005); g.gain.exponentialRampToValueAtTime(.0001, now+.04);
    o.start(now); o.stop(now+.05);
  }
  click(0,1500); click(.12,1200); click(.28,1800);
});

const triSets = [ ['⚡️','⭕️','⚡️'], ['✦','◐','☼'], ['⚙','🌀','🔮'], ['✨','🫧','⭕️'], ['🔥','🌹','⚡️'] ];
function genTriade(){ const t=triSets[Math.floor(Math.random()*triSets.length)]; const s=t.join(' '); qs('#triade').textContent=s; qs('#triadeOut').value=s; }
qs('#triadeGen').addEventListener('click', genTriade);

/* =========== Viewer controls (minimize badge) =========== */
const badgeEl=qs('#reopenBadge');
function badge(show){ badgeEl.style.display = show ? 'flex' : 'none'; }
qs('#viewerMin').addEventListener('click', ()=>{ badge(true); showTab('home'); });
qs('#viewerOpen').addEventListener('click', ()=>{ badge(false); showTab('viewer'); });
qs('#viewerBack').addEventListener('click', ()=>showTab('home'));
qs('#viewerReload').addEventListener('click', ()=>{ const f=qs('#appViewer'); const u=f.src; f.src='about:blank'; setTimeout(()=>f.src=u,100) });

/* =========== Trinity host <-> viewers =========== */
function injectToTrinity(app){
  const a=qs('#triA'); const b=qs('#triB');
  if(!a.src) a.src=app.url; else if(!b.src) b.src=app.url; else a.src=app.url;
  showTab('trinity');
}
function triPost(msg){ [qs('#triA').contentWindow, qs('#triB').contentWindow].forEach(w=>w && w.postMessage({dual:msg}, '*')); }
qs('#triSyncTheme').addEventListener('click', ()=>triPost({type:'theme', theme:'nebula-pro'}));
qs('#triSendPing').addEventListener('click', ()=>triPost({type:'ping', at:Date.now()}));
window.addEventListener('message', (e)=>{
  if(!e.data?.dual) return;
  const log = qs('#triLog');
  log.value += `[msg] ${JSON.stringify(e.data.dual)}\n`;
  log.scrollTop = log.scrollHeight;
});

/* =========== Status pop (statusBtn) =========== */
qs('#statusBtn').addEventListener('click', ()=>{
  const p=S.get(profKey,{});
  alert(`Perfil:\nNome: ${p.name||'—'}\nSK: ${p.sk?('•••'+p.sk.slice(-6)):'—'}\nApps: ${S.get(appsKey,appsDefault).length}\nFavoritos: ${S.get(favKey,[]).length}`);
});
function pingStatus(){ /* purely visual ping on save */ const d=qs('#statusBtn .dot'); d.style.background='var(--warn)'; setTimeout(()=>d.style.background='var(--ok)',350); }

/* =========== Init =========== */
loadApps(); loadBrain();
</script>
</body>
</html>